{%- comment -%}
  Renders a product card

  Accepts:
  - class: {String} Additional classes to add to the card (optional)
  - card_product: {Object} Product Liquid object (optional)
  - media_aspect_ratio: {String} Size of the product image card. Values are "square" and "portrait". Default is "square" (optional)
  - image_shape: {String} Image mask to apply to the product image card. Values are "arch", "blob", "chevronleft", "chevronright", "diamond", "parallelogram", and "round". (optional)
  - show_secondary_image: {Boolean} Show the secondary image on hover. Default: false (optional)
  - show_vendor: {Boolean} Show the product vendor. Default: false
  - show_rating: {Boolean} Show the product rating. Default: false
  - extend_height: {Boolean} Card height extends to available container space. Default: true (optional)
  - lazy_load: {Boolean} Image should be lazy loaded. Default: true (optional)
  - show_quick_add: {Boolean} Show the quick add button.
  - section_id: {String} The ID of the section that contains this card.
  - horizontal_class: {Boolean} Add a card--horizontal class if set to true. Default: false (optional)
  - horizontal_quick_add: {Boolean} Changes the quick add button styles when set to true. Default: false (optional)
  - placeholder_image: {String} The placeholder image to use when no product exists. Default: 'product-apparel-2' (optional)
  - images_slider: {Boolean} Show the images slider. Default: true (optional)
  - slides_limit: {Number} Limit the number of slides to show in the slider. Default: 5 (optional)
  - dragable: {Boolean} Enable dragable for the slider. Default: false (optional)
  -- Sample Comment
  Usage:
  {%- render 'card-product', show_vendor: section.settings.show_vendor -%}
{%- endcomment -%}
{%- assign images_slider = images_slider | default: true, allow_false: true -%}
{%- assign slides_limit = slides_limit | default: 6 -%}
{%- if card_product and card_product != empty -%}
  {%- assign bundleData = card_product.metafields.christyapp.bundleData -%}
  {%- capture variants_json %}[
    {%- for variant in card_product.variants -%}
      {"id": {{ variant.id }},"option1": "{{ variant.option1 }}","option2": "{{ variant.option2 }}","option3": "{{ variant.option3 }}"}{% unless forloop.last %},{% endunless -%}
    {%- endfor -%}
    ]
  {%- endcapture -%}
  <div
    class="product-card group/card {{ class }}"
    data-selectedid="{{ card_product.variants.first.id }}"
    data-product-handle="{{ card_product.handle }}"
    data-variants='{{ variants_json }}'
  >
    <div class="card__inner relative group/card-images">
      {%- liquid
        assign img_width = '330'
        assign widths = '400, 800, 1336'
        assign sizes = '(max-width: 1023px) 50vw, (min-width: 1024px) 330px, 100vw'

        assign class1 = 'h-full w-full object-cover opacity-0'
        assign class2 = 'h-full w-full object-cover absolute inset-0 opacity-0'

        if mob_large_img == 'true'
          assign sizes = '(max-width: 767px) 100vw, (max-width: 1024px) 50vw, (min-width: 1024px) 330px, 100vw'
        endif

        if square == true
          assign sizes = '(max-width: 767px) 100vw, (max-width: 1024px) 50vw, (min-width: 1024px) 668px, 100vw'

          assign class1 = 'h-full w-full object-cover md:object-cover'
          assign class2 = 'h-full w-full object-cover absolute inset-0 md:object-cover'
        endif

        if images_slider
          assign slider_class = 'h-full w-full absolute inset-0 xl:opacity-0 xl:group-hover/card-images:opacity-100'
        else
          assign class2 = class2 | append: ' !opacity-0 group-hover/card-images:!opacity-100 notouchhover'
        endif
      -%}
      <div class="product-images relative aspect-[1/1] block bg-grey-2">
        {%- if card_product.featured_media -%}
          {%- render 'spinner',
            class: '!m-0 !w-full !h-full flex items-center justify-center [&>svg]:w-5 [&>svg]:h-5 bg-primary-white-cotton/75'
          -%}
          {%- assign height_cropped = 330 | divided_by: 2 | plus: 330 -%}
          {%- if square == true -%}
            {%- assign height_cropped = 330 -%}
          {%- endif -%}
          {%- if card_product.featured_media.media_type == 'image' -%}
            <a href="{{ card_product.url }}">
              {%- render 'lazyimg',
                  img: card_product.featured_media,
                  width: img_width,
                  height: 330,
                  widths: widths,
                  class: class1,
                  sizes: sizes,
                  crop: 'center'
              -%}
            </a>
          {%- endif -%}
          {%- if images_slider -%}
            {%- assign limit = slides_limit -%}
            {%- assign rendered_items_count = 0 -%}
            {%- for image in card_product.images -%}
              {%- assign alt_array = image.alt | split: '-' -%}
              {%- if alt_array[1] != 'product_swatch' -%}
                {%- capture rendered_items -%}
                  {{ rendered_items }}
                  <li class="splide__slide">
                    <a href="{{ card_product.url }}">
                    {%- render 'lazyimg',
                        img: image,
                        width: img_width,
                        height: 330,
                        widths: widths,
                        class: class2,
                        sizes: sizes,
                        crop: 'center'
                    -%}
                    </a>
                  </li>
                {%- endcapture -%}
                {%- assign rendered_items_count = rendered_items_count | plus: 1 -%}
                {%- if rendered_items_count == limit -%}
                  {%- break -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- else -%}
            {%- for image in card_product.images -%}
              {%- assign alt_array = image.alt | split: '-' -%}
              {%- if alt_array[1] != 'product_swatch' and card_product.featured_media != image -%}
                {%- capture rendered_items -%}
                  <a href="{{ card_product.url }}">
                  {%- render 'lazyimg',
                      img: image,
                      width: img_width,
                      height: 330,
                      widths: widths,
                      class: class2,
                      sizes: sizes,
                      crop: 'center'
                  -%}
                  </a>
                {%- endcapture -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
          {%- if rendered_items != blank -%}
            {%- if images_slider -%}
              <product-card-slider class="aspect-square block bg-grey-2 {{ slider_class }}">
                <div class="splide custom-splider product-card-slider-js group/customSplider h-full"
                  data-splide='{"arrows": true,"pagination": true,"type": "loop","rewind": true,"cloneStatus": true,"drag": {{ dragable | default: false }},"gap": "4px"}'>
                  <div class="splide__track h-full">
                    <ul class="splide__list !flex">
                      {{- rendered_items -}}
                    </ul>
                  </div>
                  <div class="splide__arrows splide__arrows--ltr splide__custom-arrows max-lg:hidden xl:transition-opacity
                      xl:opacity-0 xl:group-hover/card-images:opacity-100">
                    <button class="splide__arrow splide__arrow--prev">
                      {%- render 'icon-arrow-drop-down' -%}
                    </button>
                    <button class="splide__arrow splide__arrow--next">
                      {%- render 'icon-arrow-drop-down' -%}
                    </button>
                  </div>
                  <ul class="{% unless dragable %}max-lg:!hidden{% endunless %} splide__pagination splide__custom-pagination splide__pagination--ltr"></ul>
                </div>
              </product-card-slider>
            {%- else -%}
              {{ rendered_items }}
            {%- endif -%}
          {%- endif -%}
        {%- endif -%}
      </div>
      {%- unless hide_badges -%}
        <div class="badge-items">
          {%- if card_product.available == false -%}
            <span
              id="Badge-{{ section_id }}-{{ card_product.id }}"
              class="badge-item badge-item-primary"
            >
              {{- 'products.product.sold_out' | t -}}
            </span>
          {%- elsif bundleData != blank -%}
            {%-assign bundleDataValue = bundleData.value -%}
            {%-assign totalPriceAct = 0 -%}
            {%-assign totalCompareAct = 0 -%}
            {%- liquid
              assign thisPrice = card_product.selected_or_first_available_variant.price | times: bundleDataValue.mainStepQuantity
              assign totalPriceAct = totalPriceAct | plus: thisPrice
              assign thisPrice = card_product.selected_or_first_available_variant.compare_at_price | times: bundleDataValue.mainStepQuantity
              assign totalCompareAct = totalCompareAct | plus: thisPrice
            -%}
            {%- if bundleDataValue.items.size > 0 -%}
              {%- for item in bundleDataValue.items -%}
                {%- liquid
                  assign selected_variants = item.variants | map: 'id' | replace: 'gid://shopify/ProductVariant/', ''
                  if all_products[item.handle].variants
                    for var in all_products[item.handle].variants
                      if selected_variants contains var.id
                        assign thisPrice = var.price | times: item.stepQuantity
                        assign totalPriceAct = totalPriceAct | plus: thisPrice
                        assign thisPrice = var.compare_at_price | times: item.stepQuantity
                        assign totalCompareAct = totalCompareAct | plus: thisPrice
                        break
                      endif
                    endfor
                  endif
                -%}
              {%- endfor -%}
            {%- endif -%}
            {%- assign totalPercentOff = 0 -%}
            {%- assign totalCompare = totalCompareAct -%}
            {%- assign totalPrice = totalPriceAct -%}
            {%- if totalCompare > totalPrice -%}
              {%- assign totalPercentOff = totalPrice
                | times: 100.0
                | divided_by: totalCompare
                | times: 100.0
                | money_without_currency
              -%}
              {%- assign totalPercentOff = 100 | minus: totalPercentOff -%}
            {%- endif -%}
            {%- if bundleDataValue.bundleDiscount > 0 -%}
              {%- assign diff = totalPrice | times: bundleDataValue.bundleDiscount | divided_by: 100 -%}
              {%- assign totalPrice = totalPrice | minus: diff -%}
            {%- endif -%}
            {%- assign totalCompareMoney = totalCompare | money_without_currency -%}
            {%- assign totalPriceMonry = totalPrice | money_without_currency -%}
            {%- assign priceDiff = totalCompareMoney | minus: totalPriceMonry -%}
            {%- assign myDis = priceDiff | divided_by: totalCompareMoney | times: 100 | round: 0 -%}
            {%- if myDis != blank and myDis > 0 -%}
              <span
                id="Badge-{{ section_id }}-{{ card_product.id }}"
                class="badge-item badge-item-primary"
              >
                -{{ myDis }}%
              </span>
            {%- endif -%}
          {%- elsif card_product.compare_at_price > card_product.price and card_product.available -%}
            <span
              id="Badge-{{ section_id }}-{{ card_product.id }}"
              class="badge-item badge-item-primary"
            >
              -
              {{-
                card_product.compare_at_price
                | minus: card_product.price
                | times: 100.0
                | divided_by: card_product.compare_at_price
                | money_without_currency
                | times: 100
                | replace: '.0', ''
              -}}
              %
            </span>
          {%- elsif card_product.metafields.christy23.plp_top_tag != blank -%}
            <div class="badge-item badge-item-secondary">{{ card_product.metafields.christy23.plp_top_tag }}</div>
          {%- endif -%}
        </div>
      {%- endunless -%}
      {%- unless hide_buttons -%}
        <div class="product-card_buttons flex justify-between items-center bg-primary-white-cotton w-full
            xl:absolute xl:left-0 xl:bottom-0 xl:opacity-0 xl:transition-opacity xl:group-hover/card:opacity-100"
        >
          <button
            type="button"
            aria-label="Add to wishlist"
            button-wishlist
            data-product-handle="{{ card_product.handle }}"
            class="
              btn-large relative btn-secondary btn-hover-animated btn-hover-animated-secondary border-none 
              [&_path]:fill-primary-white-cotton [&.active_path]:!fill-current max-xl:bg-primary-white-cotton max-xl:[&.active_path]:!fill-primary-blue
              aspect-square
              shrink-0 grow-0 w-12
            "
          >
            <span class="block">{%- render 'icon-heart' -%}</span>
          </button>
          {%- if card_product.metafields.christy23.tagline_pdp -%}
            <p
              title="{{ card_product.metafields.christy23.tagline_pdp }}"
              class="product-card_tagline text-center px-4 leading-tight line-clamp-2 font-semibold text-[11px] xl:text-xs tracking-[.5px]"
            >
              {{ card_product.metafields.christy23.tagline_pdp }}
            </p>
          {%- endif -%}
          {%- assign product_form_id = 'quick-add-' | append: section_id | append: card_product.id -%}
          <modal-opener class="shrink-0 grow-0" data-modal="#QuickAdd-{{ card_product.id }}">
            <button id="{{ product_form_id }}-submit"
                type="submit"
                name="add"
                class="quick-add__submit btn-large btn-primary xl:btn-secondary relative btn-hover-animated btn-hover-animated-secondary [&_path]:!stroke-current [&.active_path]:!fill-current
                aspect-square w-12"
                aria-haspopup="dialog"
                aria-labelledby="{{ product_form_id }}-submit title-{{ section_id }}-{{ card_product.id }}"
                data-product-url="{{ card_product.url }}">
              <span class="qatc-icon block">{%- render 'icon-plus' -%}</span>
              <span style="--color-foreground: 255,255,255" class="loading-overlay__spinner hidden">
                <svg
                    aria-hidden="true"
                    focusable="false"
                    class="spinner"
                    viewBox="0 0 66 66"
                    xmlns="http://www.w3.org/2000/svg"
                >
                  <circle class="path" fill="none" stroke-width="4" cx="33" cy="33" r="30"></circle>
                </svg>
              </span>
            </button>
          </modal-opener>
          <quick-add-modal id="QuickAdd-{{ card_product.id }}"
              class="quick-add-modal">
            <script data-related-handles type="application/json">
              {
                "related_handles": "{% for prod in card_product.collections.first.products limit:9 %}{{ prod.handle }}{% unless forloop.last %},{% endunless %}{%endfor%}"
              }
            </script>
            <div role="dialog"
                aria-label="{{ 'products.product.choose_product_options' | t: product_name: card_product.title | escape }}"
                aria-modal="true"
                class="quick-add-modal__content global-settings-popup z-[2147483605] {% if card_product.gift_card? %} quick-add-modal__content--gift-card {% endif %}"
                tabindex="-1">
              <button id="ModalClose-{{ card_product.id }}"
                  type="button"
                  class="quick-add-modal__toggle  {% if product.gift_card? %} !z-[50] !mt-1.5 !mr-1.5 {% endif %}"
                  aria-label="{{ 'accessibility.close' | t }}">
                {%- render 'icon-close' -%}
              </button>
              <div id="QuickAddInfo-{{ card_product.id }}" class="quick-add-modal__content-info"></div>
            </div>
          </quick-add-modal>
        </div>
      {%- endunless -%}
    </div>
    <div class="px-4 flex flex-col card__content text-blue-1 mt-2 xl:mt-4">
      {%- assign product_title = bundleData.value.bundleTitle | default: card_product.title | escape -%}
      <a
        href="{{ card_product.url }}"
        id="CardLink-{{ section_id }}-{{ card_product.id }}"
        aria-labelledby="CardLink-{{ section_id }}-{{ card_product.id }} Badge-{{ section_id }}-{{ card_product.id }}"
        class="card__information space-y-1"
        title="{{ product_title }}"
      >
        <h3
          class="product-card_title text-sm font-semibold tracking-[.1px] font-sans md:font-normal xl:text-base xl:tracking-[.5px]
            {% if class == 'product-card--horizontal' %}two-line-text{% else %}truncate{% endif %}"
          id="title-{{ section_id }}-{{ card_product.id }}"
        >
          {{ product_title }}
        </h3>
        <div class="flex justify-between flex-wrap text-sm tracking-[.25px] font-normal">
          {%- if bundleData != blank -%}
            {%- assign bundleDataValue = bundleData.value -%}
            {%- assign totalPriceAct = 0 -%}
            {%- assign totalCompareAct = 0 -%}

            {%- liquid
              assign thisPrice = card_product.selected_or_first_available_variant.price | times: bundleDataValue.mainStepQuantity
              assign totalPriceAct = totalPriceAct | plus: thisPrice
              assign thisPrice = card_product.selected_or_first_available_variant.compare_at_price | times: bundleDataValue.mainStepQuantity
              assign totalCompareAct = totalCompareAct | plus: thisPrice
            -%}
            {%- if bundleDataValue.items.size > 0 -%}
              {%- for item in bundleDataValue.items -%}
                {%- liquid
                  assign selected_variants = item.variants | map: 'id' | replace: 'gid://shopify/ProductVariant/', ''
                  if all_products[item.handle].variants
                    for var in all_products[item.handle].variants
                      if selected_variants contains var.id
                        assign thisPrice = var.price | times: item.stepQuantity
                        assign totalPriceAct = totalPriceAct | plus: thisPrice
                        assign thisPrice = var.compare_at_price | times: item.stepQuantity
                        assign totalCompareAct = totalCompareAct | plus: thisPrice
                        break
                      endif
                    endfor
                  endif
                -%}
              {%- endfor -%}
            {%- endif -%}
            {%- assign totalPercentOff = 0 -%}
            {%- assign totalCompare = totalCompareAct -%}
            {%- assign totalPrice = totalPriceAct -%}
            {%- if totalCompare > totalPrice -%}
              {%- assign totalPercentOff = totalPrice
                | times: 100.0
                | divided_by: totalCompare
                | times: 100.0
                | money_without_currency
              -%}
              {%- assign totalPercentOff = 100 | minus: totalPercentOff -%}
            {%- endif -%}
            {%- if bundleDataValue.bundleDiscount > 0 -%}
              {%- assign diff = totalPrice | times: bundleDataValue.bundleDiscount | divided_by: 100 -%}
              {%- assign totalPrice = totalPrice | minus: diff -%}
            {%- endif -%}
            {%- render 'bundle-builder-price',
              totalCompare: totalCompare,
              totalPrice: totalPrice,
              totalPercentOff: totalPercentOff,
              bundleDiscount: bundleDataValue.bundleDiscount,
              noWrap: true,
              showOnlyDiscount: true,
              hideSavingsMob: true
            -%}
          {%- else -%}
            <div class="whitespace-nowrap">
              {%- if card_product.price_min != card_product.price_max -%}
                {%- assign max_variant = card_product.variants | sort: "price" | last -%}
                <p>
                  {{ card_product.price_min | money }} - {{ card_product.price_max | money }}
                  {%- if max_variant.compare_at_price > max_variant.price -%}
                    <span class="line-through hidden">
                      {{ max_variant.compare_at_price | money }}
                    </span>
                  {%- endif -%}
                </p>
              {%- else -%}
                {%- if card_product.compare_at_price > card_product.price -%}
                  <p>
                    <span>
                      {{ card_product.price | money }}
                    </span>
                    <span class="line-through text-gray-500">
                      {{ card_product.compare_at_price | money }}
                    </span>
                  </p>
                {%- else -%}
                  <p>{{ card_product.price | money }}</p>
                {%- endif -%}
              {%- endif -%}
            </div>
          {%- endif -%}
          {%- if show_rating -%}
            {% comment %}<div
              class="ruk_rating_snippet"
              data-sku="{{ card_product.handle }};{{ card_product.variants | map: 'sku' | join: ';' }};{{ card_product.variants | map: 'id' | join: ';' }}"
            ></div>
            {% endcomment %}
            <div class="yotpo bottomLine yotpo-card-product-container" data-product-id="{{ card_product.id }}"></div>
          {%- endif -%}
        </div>
      </a>
      {%- unless card_product.has_only_default_variant -%}
        {%- assign coloursCount = 0 -%}
        {%- assign coloursVisible = 0 -%}
        {%- assign smallCardLimit = 3 -%}
        {%- assign coloursLimit = 5 -%}
        {%- capture optionColours -%}
          {%- for option in card_product.options_with_values -%}
            {%- if option.name == 'Colour' or option.name == 'Color' -%}
              {%- for value in option.values -%}
                {%- assign option_swatch_image = '' -%}
                {%- for image in card_product.images -%}
                  {%- assign alt_array = image.alt | split: '-' -%}
                  {%- assign alt_striped = alt_array[0] | strip -%}
                  {%- assign colour_striped = value | strip -%}
                  {%- if colour_striped == alt_striped and alt_array[1] == 'product_swatch' -%}
                    {%- assign option_swatch_image = image -%}
                    {%- break -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if option_swatch_image != blank -%}
                  {%- if coloursCount < coloursLimit -%}
                    {%- assign coloursVisible = coloursVisible | plus: 1 -%}
                    <a href="{{ card_product.url | split: '?' | first }}/c:{{ value | handleize }}"
                        class="h-auto w-full rounded-full [&.active]:border [&.active]:border-primary-blue
                        [&.active_.swatch]:scale-90 flex items-center justify-center {% if coloursCount >= smallCardLimit %} small-card_color-hide{% endif %}"
                        data-get-slider="{{ images_slider | json }}"
                        data-slider-draggable="{{ dragable | json }}">
                      <div class="pt-[100%] flex-1 relative">
                        <div
                            class="swatch w-full h-full transition-[width,height] rounded-full absolute inset-0 transition-transform"
                            style="background-image: url({{ option_swatch_image | img_url: '24x24' }});"
                        ></div>
                      </div>
                    </a>
                  {%- endif -%}
                  {%- assign coloursCount = coloursCount | plus: 1 -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endcapture -%}
        {%- if coloursCount > 1 -%}
          <div
            class="card__colours grid grid-cols-[repeat(5,minmax(auto,24px))_1fr] gap-1 xl:gap-2 items-center mt-3 xl:mt-2"
            data-count="{{ coloursCount }}"
          >
            {{ optionColours }}
            {%- liquid
              assign colourCountActual = coloursCount
              assign tabColourCount = colourCountActual | minus: coloursLimit
              assign tabColourCountSmall = colourCountActual | minus: smallCardLimit
            -%}
            {%- if tabColourCount > 0 or tabColourCountSmall > 0 -%}
              <div class="leading-tight text-[11px] font-semibold tracking-[.5px] xl:text-sm xl:font-normal xl:tracking-[.25px]">
                {%- if tabColourCount > 0 -%}
                  <a href="{{ card_product.url }}"
                    class="card_colors-more xl:hover:underline {% if class == 'product-card--horizontal' %}text-nowrap{% endif %}"
                    >+{{ tabColourCount }} more</a>
                {%- endif -%}
                {%- if tabColourCountSmall > 0 -%}
                  <a href="{{ card_product.url }}"
                      class="hidden small-card_colors-more"
                  >+{{ tabColourCountSmall }} more</a>
                {%- endif -%}
              </div>
            {%- endif -%}
          </div>
        {%- endif -%}
      {%- endunless -%}
      {%- if class == 'product-card--horizontal' -%}
        <a href="{{ card_product.url }}" class="xl:hidden text-sm text-primary-blue font-semibold underline mt-3"
          >Details</a>
      {%- endif -%}
    </div>
  </div>
{%- else -%}
  <div class="card-wrapper product-card-wrapper underline-links-hover">
    <div class="card card--{{ settings.card_style }} card--text {% if extend_height %} card--extend-height{% endif %}{% if settings.card_style == 'card' %} color-{{ settings.card_color_scheme }} gradient{% endif %}{% if card_product.featured_media == blank and settings.card_style == 'card' %} ratio{% endif %} {{ horizontal_class }}"
      style="--ratio-percent: 100%;">
      <div
        class="card__inner {% if settings.card_style == 'standard' %}color-{{ settings.card_color_scheme }} gradient{% endif %}{% if settings.card_style == 'standard' %} ratio{% endif %}"
        style="--ratio-percent: 100%;"
      >
        <div class="card__media">
          {%- if placeholder_image -%}
            {{ placeholder_image | placeholder_svg_tag: 'placeholder-svg' }}
          {%- else -%}
            {{ 'product-apparel-2' | placeholder_svg_tag: 'placeholder-svg' }}
          {%- endif -%}
        </div>
      </div>
      <div class="card__content">
        <div class="card__information">
          <h3 class="card__heading card__heading--placeholder{% if settings.card_style == 'standard' %} h5{% endif %}">
            <a role="link" aria-disabled="true" class="full-unstyled-link">
              {{ 'onboarding.product_title' | t }}
            </a>
          </h3>
          <div class="card-information">
            {%- if show_vendor -%}
              <span class="visually-hidden">{{ 'accessibility.vendor' | t }}</span>
              <div class="caption-with-letter-spacing light">{{ 'products.product.vendor' | t }}</div>
            {%- endif -%}
            {%- render 'price' -%}
          </div>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}
